# 阅读《网络是怎样连接的》

<!-- TOC -->

- [1. 浏览器生成消息--探索浏览器内部](#1-浏览器生成消息--探索浏览器内部)
- [2. 用电信号传输 TCP/IP 数据](#2-用电信号传输-tcpip-数据)
    - [2.1. 创建套接字](#21-创建套接字)
    - [2.2. 连接服务器](#22-连接服务器)
    - [2.3. 收发数据](#23-收发数据)
    - [2.4. 从服务器断开并删除套接字](#24-从服务器断开并删除套接字)
    - [2.5. IP 与以太网的包收发操作](#25-ip-与以太网的包收发操作)
    - [2.6. UDP 协议的收发操作](#26-udp-协议的收发操作)
- [3. 网线到网络设备](#3-网线到网络设备)
    - [3.1. 信号在网线和集线器中传输](#31-信号在网线和集线器中传输)
    - [交换机的包转发操作](#交换机的包转发操作)

<!-- /TOC -->

## 1. 浏览器生成消息--探索浏览器内部



## 2. 用电信号传输 TCP/IP 数据

从内部协议栈的角度来分析数据是如何处理数据发送请求的。

协议栈内部场景来进行讨论。

应用程序收到委托后，协议栈通过 TCP 协议收发数据的操作可以分为4个阶段：

1. 创建套接字
2. 连接服务器
3. 收发数据：协议栈会将从应用程序收到的数据切分成小块并发送给服务器，考虑到通信过程中可能会出错导致网络包丢失，协议栈还需要确认切分出的每个包是否已经送达服务器。
4. 从服务器断开连接并删除套接字

### 2.1. 创建套接字

- 浏览器、邮件等一般应用程序收发数据时用 TCP；
- DNS 查询等收发较短的控制数据时用 UDP。

**套接字的实体就是通信控制信息**

套接字的作用：套接字中记录了用于控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步的行动。

> 协议栈是根据套接字中记录的控制信息来工作的。

- Socket(大写) 表示 Socket 库
- socket(小写) 表示 Socket 库中名为 socket 的程序组件

> 创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态。

不同的应用程序收发的数据内容不同，但收发数据的操作是共通的。应用程序的下面是 Socket 库，包括解析器，用来向 DNS 服务器发出查询。

- ICMP 用于告知网络包传送过程中产生的错误以及各种控制信息
- ARM 用于根据 IP 地址查询相应的以太网 MAC 地址

### 2.2. 连接服务器

创建套接字之后，应用程序就会调用 `connect`，随后协议栈会将本地的套接字和服务器的套接字进行连接（通信双方交换控制信息）。

控制信息：用来控制数据收发操作所需的一些信息。
1. 客户端和服务器相互联络时交换的控制信息，**头部**是用来记录和交换控制信息的
2. 保存在套接字中，用来控制协议栈操作的信息

> 连接操作的第一步是在 TCP 模块处创建表示连接控制信息的头部
> 通过 TCP 头部中的发送方和接受方端口号可以找到要连接的套接字

在断开前，连接（会话）是一直存在的。

连接建立完成之后，connect 执行完毕，控制流程被交回到应用程序。

### 2.3. 收发数据

将 HTTP 请求消息消息交给协议栈。

- 协议栈不关心应用程序传来的数据内容
- 协议栈将数据进行缓存（应用程序发送多少数据不是协议栈能控制的，如果一收到就发送，会导致网络效率下降）

- MTU: 一个网络包的最大长度，一般为1500字节
- MSS: 除去头部之后，一个网络包能容纳的 TCP 数据的最大长度

一般需要权衡时间和包的长度，这两个矛盾的要素。

TCP 采用这样的方式确认对方是否收到了数据，在对方确认之前，发送过的包都会保存在发送缓冲区中，如果对方没有返回某些包对应的 ACK 号，那么就重新发送这些包。

TCP 采用动态调整等待时间的方法，根据 ACK 号返回所需的时间来判断。

通过 “序号” 和 “ACK 号” 可以确认接收方是否收到了网络包。

### 2.4. 从服务器断开并删除套接字

这里需要注意，客户端删除套接字并不是立马执行的，为了防止网络丢包，导致的 ACK 没有传达到，然后又新开同一个端口的应用程序，从而将之断开等误操作。

### 2.5. IP 与以太网的包收发操作

- 路由器：根据目标地址判断下一个路由器的位置
- 集线器：在子网中将网络包传输到下一个路由
- IP 协议根据目标地址盘算下一个 IP 转发设备的位置
- 子网中的以太网协议将包传输到下一个转发设备

IP 模块分则添加如下两个头部：
1. MAC 头部：以太网用的头部，包含 MAC 地址
2. IP 头部：IP 用的头部，包含 IP 地址

以太网3个性质：
1. 将包发送到 MAC 头部的接收方 MAC 地址代表的目的地
2. 用发送方 MAC 地址识别发送方
3. 用以太网类型识别包的内容

### 2.6. UDP 协议的收发操作

场景：
1. DNS 查询 IP
2. 音频和视频数据（一旦错过播放，会产生失真或者卡顿，但一般可以接受）

效率高

## 3. 网线到网络设备

将网络包转化成电信号通过网线传输除去的过程。

（集线器、路由器）

1. 信号在网线和集线器中传输
    - 信号在传输过程中会衰减，还会受到噪声干扰而失真
2. 交换机的包转发操作
    - 交换机不只是简单地让信号流过，而是先接收信号并讲起还原为数字信息，然后再重新转化为信号并发送除去的过程
3. 路由器的包转发操作
    - 交换机是基于以太网规格工作的设备，而路由器是基于 IP 工作的。
4. 路由器的附加功能
    - 例如将私有地址转化为公有地址，阻止危险网络包的包过滤

路由器（1986/1987 思科）比交换机（1993）更早出现

### 3.1. 信号在网线和集线器中传输

PHY(MAU) 以太网有多重派生方式，物理层装置（高速），介质连接单元（低速）

- 每个包独立传输，需要考虑信号衰减，通过“双绞”是为了抑制噪声。
- 节距越大，抵消噪音的效果越好。
- 信号线之间加入隔板保持距离，外面包裹阻挡电磁波的金属屏蔽网。

集线器会将信号广播到整个网络中，然后据接收方 MAC 地址来判断应该接收哪些包。

MDI - 媒体相关接口
MDI-X - MDI-Crossover 的缩写

中继电路：将输入信号广播到集线器的所有端口上。然后信号从接口流出，到达集线器所在的所有设备。设备根据 MAC 头部判断是否是自己的。

**集线器将信号发送给所有连接在它上面的线路**

### 交换机的包转发操作

交换机设计，是将网络包原样转发到目的地。

如果在计算机上安装多块网卡，并开启“混杂模式”让网卡接收所有的网络包，然后再安装一个和交换机具备同样功能的网络包转发软件，那么这个计算机就是一台交换机。


