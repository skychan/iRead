# 阅读《网络是怎样连接的》

<!-- TOC -->

- [1. 浏览器生成消息--探索浏览器内部](#1-浏览器生成消息--探索浏览器内部)
- [2. 用电信号传输 TCP/IP 数据](#2-用电信号传输-tcpip-数据)
    - [2.1. 创建套接字](#21-创建套接字)
    - [2.2. 连接服务器](#22-连接服务器)
    - [2.3. 收发数据](#23-收发数据)
    - [2.4. 从服务器断开并删除套接字](#24-从服务器断开并删除套接字)
    - [2.5. IP 与以太网的包收发操作](#25-ip-与以太网的包收发操作)
    - [2.6. UDP 协议的收发操作](#26-udp-协议的收发操作)
- [3. 网线到网络设备](#3-网线到网络设备)
    - [路由器的包转发操作](#路由器的包转发操作)

<!-- /TOC -->

## 1. 浏览器生成消息--探索浏览器内部



## 2. 用电信号传输 TCP/IP 数据

从内部协议栈的角度来分析数据是如何处理数据发送请求的。

协议栈内部场景来进行讨论。

应用程序收到委托后，协议栈通过 TCP 协议收发数据的操作可以分为4个阶段：

1. 创建套接字
2. 连接服务器
3. 收发数据：协议栈会将从应用程序收到的数据切分成小块并发送给服务器，考虑到通信过程中可能会出错导致网络包丢失，协议栈还需要确认切分出的每个包是否已经送达服务器。
4. 从服务器断开连接并删除套接字

### 2.1. 创建套接字

- 浏览器、邮件等一般应用程序收发数据时用 TCP；
- DNS 查询等收发较短的控制数据时用 UDP。

**套接字的实体就是通信控制信息**

套接字的作用：套接字中记录了用于控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步的行动。

> 协议栈是根据套接字中记录的控制信息来工作的。

- Socket(大写) 表示 Socket 库
- socket(小写) 表示 Socket 库中名为 socket 的程序组件

> 创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态。

不同的应用程序收发的数据内容不同，但收发数据的操作是共通的。应用程序的下面是 Socket 库，包括解析器，用来向 DNS 服务器发出查询。

- ICMP 用于告知网络包传送过程中产生的错误以及各种控制信息
- ARM 用于根据 IP 地址查询相应的以太网 MAC 地址

### 2.2. 连接服务器

创建套接字之后，应用程序就会调用 `connect`，随后协议栈会将本地的套接字和服务器的套接字进行连接（通信双方交换控制信息）。

控制信息：用来控制数据收发操作所需的一些信息。
1. 客户端和服务器相互联络时交换的控制信息，**头部**是用来记录和交换控制信息的
2. 保存在套接字中，用来控制协议栈操作的信息

> 连接操作的第一步是在 TCP 模块处创建表示连接控制信息的头部
> 通过 TCP 头部中的发送方和接受方端口号可以找到要连接的套接字

在断开前，连接（会话）是一直存在的。

连接建立完成之后，connect 执行完毕，控制流程被交回到应用程序。

### 2.3. 收发数据

将 HTTP 请求消息消息交给协议栈。

- 协议栈不关心应用程序传来的数据内容
- 协议栈将数据进行缓存（应用程序发送多少数据不是协议栈能控制的，如果一收到就发送，会导致网络效率下降）

- MTU: 一个网络包的最大长度，一般为1500字节
- MSS: 除去头部之后，一个网络包能容纳的 TCP 数据的最大长度

一般需要权衡时间和包的长度，这两个矛盾的要素。

TCP 采用这样的方式确认对方是否收到了数据，在对方确认之前，发送过的包都会保存在发送缓冲区中，如果对方没有返回某些包对应的 ACK 号，那么就重新发送这些包。

TCP 采用动态调整等待时间的方法，根据 ACK 号返回所需的时间来判断。

通过 “序号” 和 “ACK 号” 可以确认接收方是否收到了网络包。

### 2.4. 从服务器断开并删除套接字

这里需要注意，客户端删除套接字并不是立马执行的，为了防止网络丢包，导致的 ACK 没有传达到，然后又新开同一个端口的应用程序，从而将之断开等误操作。

### 2.5. IP 与以太网的包收发操作

- 路由器：根据目标地址判断下一个路由器的位置
- 集线器：在子网中将网络包传输到下一个路由
- IP 协议根据目标地址盘算下一个 IP 转发设备的位置
- 子网中的以太网协议将包传输到下一个转发设备

IP 模块分则添加如下两个头部：
1. MAC 头部：以太网用的头部，包含 MAC 地址
2. IP 头部：IP 用的头部，包含 IP 地址

以太网3个性质：
1. 将包发送到 MAC 头部的接收方 MAC 地址代表的目的地
2. 用发送方 MAC 地址识别发送方
3. 用以太网类型识别包的内容

### 2.6. UDP 协议的收发操作

场景：
1. DNS 查询 IP
2. 音频和视频数据（一旦错过播放，会产生失真或者卡顿，但一般可以接受）

效率高

## 3. 网线到网络设备

将网络包转化成电信号通过网线传输除去的过程。

（集线器、路由器）

1. 信号在网线和集线器中传输
    - 信号在传输过程中会衰减，还会受到噪声干扰而失真
2. 交换机的包转发操作
    - 交换机不只是简单地让信号流过，而是先接收信号并讲起还原为数字信息，然后再重新转化为信号并发送除去的过程
3. 路由器的包转发操作
    - 交换机是基于以太网规格工作的设备，而路由器是基于 IP 工作的。
4. 路由器的附加功能
    - 例如将私有地址转化为公有地址，阻止危险网络包的包过滤


**交换机端口的 MAC 模块不具有 MAC 地址**
（内置用于实现管理功能的处理器的交换机除外）

交换电路是交换机的原型。

由于交换机是通过将一段时间不用的记录从地址表中删除的做法，因此，还是有可能将包发送到错误的设备。这种情况极为罕见，但的确也会发生。遇到这样的情况，只要重启一下交换机，地址表就会被情况并更新正确的信息，然后网络就可以正常工作了。

如果接收方 MAC 地址是一个广播地址（FF:FF:FF:FF:FF:FF），那么交换机会将包发送到除源端口之外的所有端口。

**全双工模式可以同时进行发送和接收**

- 只要不用集线器，就不会发生碰撞。
- 使用双绞线时，发送和接收信号线是各自独立的，因此在双绞线中信号也不会发生碰撞。
- 交换机端口和网卡的 PHY、MAC 模块，其内部电路（收发）独立，信号也不会碰撞。

全双工模式：无论网络中有没有信号，都可以发送信号的工作模式，同时规定在这一工作模式下停用碰撞检测。无需等待其他信号结束就可以发送信号，比半双工模式速度要快。由于双分可以同时发送数据，所以可以同时传输的数据量也更大，性能也就更高。

自动协商：确定最优的传输速率。自动切换工作模式，探测对方的传输速率，并自动切换。

以太网中，没有数据信号时，就会填充连接脉冲，使得网络中一直都有一定的信号流过，从而检测对方是否在正常工作，或者网线有没有正常连接。

利用脉冲信号，可以进行自动协商。

交换机只将包转发到具有特定 MAC 地址的设备连接端口，其他端口都是空闲的。可以传输其他的包，因此交换机可以同时转发多个包。

### 路由器的包转发操作

路由器通过查表判断包转发的目标。

- 路由器：基于 IP 设计的
- 交换器：基于以太网设计的


路由器主要的

1. 包转发模块：评断包的转发目的地（类似于 IP 模块）
2. 端口模块：包的收发操作（类似于 网卡）

路由器的端口模块，支持除局域网之外的多种通信技术，
- ADSL
- FTTH
- 各种宽带专线等

端口模块是以实际的发送方或者接收方的身份来收发网络包的。

路由器的以太网端口，具有 MAC 地址，可以称为以太网的发送和接收方。
端口还具有 IP 地址，从这个意义上来说，它和计算机的网卡是一样的。

转发包时，路由器端口会接收发给自己的以太网包，然后查询转发目标，再由相应的端口作为发送方将以太网包发送除去。这一点和交换机不一样，交换机只是将进来包转发出去而已，它自己不会成为接收或者发送方。

**路由器的各个端口都具有 MAC 地址和 IP 地址**

但是路由器的端口不会成为 IP 的发送和接收方，MAC 地址可以。

路由器根据 IP 头部中的 IP 地址来进行转发的。

路由器会忽略主机号,只匹配网络号。

有时地址本身的子网掩码和路由表中的子网掩码是不一致的,这是路由聚合的结果。路由聚合会将几个子网合并成一个子网,并在路由表中只产生一条记录。

跃点计数：表示距离目标 IP 地址的距离是远还是近。数字越小，距离越近，数字越大，距离越远。

交换机中对 MAC 地址表的维护是包转发操作中的一个步骤，而路由器中对路由表的维护与包转发操作是相互独立的。转发包的过程中不需要对路由表的内容进行维护。

如果在路由表中无法找到匹配的记录,路由器会丢弃这个包,并通过 ICMP 消息告知发送方。

路由器遇到不知道该转发到哪里的包，就会直接丢弃。而不是进行广播。

包的有效期：查到转发目标之后，网络包就会被转发交给输出端口，并最终发送出去。
但是，先要
1. 更新 IP 头部中的 TTL (生存时间)，表示包的有效期，包每经过一个路由器的转发，值就会减 1，当这个值变成 0 时，就表示超过了有效期。（主要是为了防止死循环）

不同线路的和局域网类型各自能传输的最大包长度不同，可能出现输出端口的最大包长度可能会小于输入端口。即便两个端口最大包长度相同，也可能因为添加了一些头部数据而导致包的实际长度发生变化。长度超过，就不能直接发送了。

将头部和数据分开，数据进行拆分。一般来说，数据都是可分的，除非：
1. 发送方应用程序设置了不允许分片
2. 这个包已经经过分片

**路由器与交换机的关系**

要理解两者之间的关系，关键点在于计算机在发送网络包时，或者是路由器在转发网络包时，都需要在前面加上 MAC 头部。

IP(路由器)负责将包发送给通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网(交换机)来负责的。
